# Settings for Gravy
#
# To override, create a file in:
#   /etc/smashpig/gravy/main.yaml
#   $HOME/.smashpig/gravy/main.yaml
logging:
  root-context: SmashPig-Gravy

api:
  class: SmashPig\PaymentProviders\Gravy\Api

gravy-id: wikimedia

api-prefix: sandbox

endpoints:
  listener:
    class: SmashPig\PaymentProviders\Gravy\GravyListener

merchantAccountId: default

privateKeyLocation: /srv/config/private/gr4vy/private_key.pem

report-location: /tmp

accounts:
  webhook:
    username: WikimediaFoundationTest
    password: 'FoundationTest'

# By default, cache payment method lookups for 5 minutes
common-cache-parameters: &CACHE
  cache-parameters:
    duration: 300
    key-base: SMASHPIG_GRAVY_METHODS

payment-provider:
  cc:
    class: SmashPig\PaymentProviders\Gravy\CardPaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/cc-request"
        response-mapper: "mappers/cc-response"
        validator: "validators/cc"
        <<: *CACHE
  google:
    class: SmashPig\PaymentProviders\Gravy\GooglePayPaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/google-request"
        response-mapper: "mappers/google-response"
        validator: "validators/google"
        <<: *CACHE

  apple:
    class: SmashPig\PaymentProviders\Gravy\ApplePayPaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/apple-request"
        response-mapper: "mappers/apple-response"
        validator: "validators/apple"
        <<: *CACHE

  dd:
    class: SmashPig\PaymentProviders\Gravy\DirectDepositPaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/dd-request"
        response-mapper: "mappers/dd-response"
        validator: "validators/dd"
        <<: *CACHE

  bt:
    class: SmashPig\PaymentProviders\Gravy\BankPaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/bt-request"
        response-mapper: "mappers/bt-response"
        validator: "validators/redirect"
        <<: *CACHE

  venmo:
    class: SmashPig\PaymentProviders\Gravy\RedirectPaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/venmo-request"
        response-mapper: "mappers/venmo-response"
        validator: "validators/venmo"
        <<: *CACHE

  paypal:
    class: SmashPig\PaymentProviders\Gravy\PaypalPaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/paypal-request"
        response-mapper: "mappers/paypal-response"
        validator: "validators/paypal"
        <<: *CACHE

  cash:
    class: SmashPig\PaymentProviders\Gravy\RedirectPaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/redirect-request"
        response-mapper: "mappers/redirect-response"
        validator: "validators/redirect"
        <<: *CACHE

  rtbt:
    class: SmashPig\PaymentProviders\Gravy\BankPaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/bt-request"
        response-mapper: "mappers/bt-response"
        validator: "validators/redirect"
        <<: *CACHE

  stripetoken:
    class: SmashPig\PaymentProviders\Gravy\PaymentProvider
    constructor-parameters:
      -
        request-mapper: "mappers/stripetoken-request"
        response-mapper: "mappers/stripetoken-response"
        validator: "validators/default"
        <<: *CACHE


# Setting value to false to mirror production configuration
capture-from-ipn-listener: false

proxy:
  proxy_host: ~ # example.proxy.url
  proxy_port: -1 # 80

error-checker:
  # Service responsible for detecting and categorizing payment errors from API responses
  class: SmashPig\PaymentProviders\Gravy\Errors\ErrorChecker

error-tracker:
  # Service that monitors error frequency and triggers alerts when thresholds are exceeded
  # Uses Redis to track error counts within expiring time buckets
  class: SmashPig\PaymentProviders\Gravy\Errors\ErrorTracker
  constructor-parameters:
    -
      # Redis-based tracking and alerting can be toggled on/off.
      enabled: true
      # Number of errors required to trigger an alert (default: 20)
      threshold: 20
      # Time window in seconds for error counting (1800 = 30 minutes)
      time_window: 1800
      # Redis key prefix for storing error counts
      key_prefix: 'gravy_error_threshold_'
      # Redis key expiry period in seconds (default: 2400 = 40 minutes)
      key_expiry_period: 2400
      # Alert suppression period in seconds to prevent duplicate alerts (default: 300 = 5 minutes)
      alert_suppression_period: 300
      # List of error codes to ignore from tracking and alerting
      ignore_list:
        # We get this error when a PayPal transaction times out
        - 'incomplete_buyer_approval'
        # We get this error when a donor cancels a payment
        - 'cancelled_buyer_approval'
        # We get these for non-standard declines. e.g. Insufficient funds & Exceeding daily card limits.
        # Gravy mentions that we can also get them due to legal reasons (e.g. watch list, embargo, sanctions).
        # See: https://docs.gr4vy.com/guides/api/error-codes
        - 'refused_transaction'
        # We get this when the cvv does not match
        - 'incorrect_cvv'
        # We get this when the card does not have enough funds
        - 'insufficient_funds'

notifications:
  fraud-alerts:
    to:
      - 'fr-tech@wikimedia.org'

mappers:
  cc-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\CardPaymentProviderRequestMapper
  cc-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\CardPaymentProviderResponseMapper
  redirect-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\RedirectPaymentProviderRequestMapper
  redirect-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\RedirectPaymentProviderResponseMapper
  apple-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\ApplePayPaymentProviderRequestMapper
  apple-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\ApplePayPaymentProviderResponseMapper
  google-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\GooglePayPaymentProviderRequestMapper
  google-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\GooglePayPaymentProviderResponseMapper
  dd-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\DirectDepositPaymentProviderRequestMapper
  dd-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\DirectDepositPaymentProviderResponseMapper
  paypal-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\PaypalPaymentProviderRequestMapper
  paypal-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\RedirectPaymentProviderResponseMapper
  bt-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\BankPaymentProviderRequestMapper
  bt-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\BankPaymentProviderResponseMapper
  rtbt-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\BankPaymentProviderRequestMapper
  rtbt-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\BankPaymentProviderResponseMapper
  cash-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\RedirectPaymentProviderRequestMapper
  cash-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\RedirectPaymentProviderResponseMapper
  venmo-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\VenmoPaymentProviderRequestMapper
  venmo-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\RedirectPaymentProviderResponseMapper
  stripetoken-request:
    class: SmashPig\PaymentProviders\Gravy\Mapper\RequestMapper
  stripetoken-response:
    class: SmashPig\PaymentProviders\Gravy\Mapper\ResponseMapper

validators:
  cc:
    class: SmashPig\PaymentProviders\Gravy\Validators\CardPaymentProviderValidator
  redirect:
    class: SmashPig\PaymentProviders\Gravy\Validators\RedirectPaymentProviderValidator
  apple:
    class: SmashPig\PaymentProviders\Gravy\Validators\ApplePayPaymentProviderValidator
  google:
    class: SmashPig\PaymentProviders\Gravy\Validators\GooglePayPaymentProviderValidator
  dd:
    class: SmashPig\PaymentProviders\Gravy\Validators\DirectDepositPaymentProviderValidator
  paypal:
    class: SmashPig\PaymentProviders\Gravy\Validators\PaypalPaymentProviderValidator
  venmo:
    class: SmashPig\PaymentProviders\Gravy\Validators\VenmoPaymentProviderValidator
  default:
    class: SmashPig\PaymentProviders\Gravy\Validators\PaymentProviderValidator

fraud-filters:
  # Authorization notifications include AVS and CVV result codes.
  # The following maps set a risk score for each result code, which
  # we combine with any risk score computed on the payment site to
  # decide whether to capture the payment or leave it for review.
  # https://docs.gr4vy.com/reference/transactions/new-transaction#:~:text=otherwise%20approved%20before.-,avs_response_code,-enum%3Cstring%3E%20%7C%20null
  avs-map:
    # no_match - neither address or postal code match
    no_match: 100
    # match - both address and postal code match
    match: 0
    # partial_matches - matches some part of the data
    partial_match_address: 75
    partial_match_postcode: 75
    partial_name_match: 75
    # unavailable - AVS is unavailable for card/country
    unavailable: 50

  # https://docs.gr4vy.com/reference/transactions/new-transaction#:~:text=for%20this%20transaction.-,cvv_response_code,-enum%3Cstring%3E%20%7C%20null
  cvv-map:
    # no_match - the CVV does not match the expected value
    no_match: 100
    # match - the CVV matches the expected value
    match: 0
    # not_provided -  CVV not provided
    not_provided: 100
    # unavailable -  CVV check unavailable for card our country
    unavailable: 50
